{% extends 'base.html' %}
{% load static %}

{% block title %}Train Model - {{ model.name }}{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-8">
    <!-- Header -->
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold text-white">Train Model</h1>
            <p class="text-gray-400">{{ model.name }}</p>
        </div>
        <a href="{% url 'app:model_detail' model.id %}" 
           class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
            Back to Model
        </a>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Training Parameters -->
        <div class="lg:col-span-1">
            <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-6 border border-red-800/20">
                <h2 class="text-xl font-semibold text-white mb-6 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
                    </svg>
                    Training Parameters
                </h2>
                
                <form method="post" id="trainingForm" class="space-y-6">
                    {% csrf_token %}
                    
                    <div>
                        <label for="dataset" class="block text-sm font-medium text-gray-300 mb-2">Select Dataset</label>
                        <select class="mt-1 block w-full rounded-md bg-gray-900/50 border border-red-800/30 text-white shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm"
                                id="dataset" name="dataset" required>
                            <option value="">Choose a dataset...</option>
                            {% for dataset in datasets %}
                            <option value="{{ dataset.id }}">{{ dataset.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div>
                        <label for="alpha" class="block text-sm font-medium text-gray-300 mb-2">Learning Rate (Î±)</label>
                        <input type="number" 
                               class="mt-1 block w-full rounded-md bg-gray-900/50 border border-red-800/30 text-white shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm"
                               id="alpha" name="alpha" 
                               value="{{ model.parameters.alpha }}" 
                               step="0.0001" min="0.0001" max="1" required>
                        <p class="mt-1 text-sm text-gray-400">Controls how quickly the model learns (0.0001 to 1)</p>
                    </div>
                    
                    <div>
                        <label for="iterations" class="block text-sm font-medium text-gray-300 mb-2">Number of Iterations</label>
                        <input type="number" 
                               class="mt-1 block w-full rounded-md bg-gray-900/50 border border-red-800/30 text-white shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm"
                               id="iterations" name="iterations" 
                               value="{{ model.parameters.iterations|default:'1000' }}" 
                               min="100" max="10000" required>
                        <p class="mt-1 text-sm text-gray-400">Number of training iterations (100 to 10000)</p>
                    </div>
                    
                    <button type="submit" 
                            class="w-full flex justify-center items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Start Training
                    </button>
                </form>
            </div>
        </div>

        <!-- Training History -->
        <div class="lg:col-span-2">
            <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-6 border border-red-800/20">
                <h2 class="text-xl font-semibold text-white mb-6 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Training Details
                </h2>

                {% if last_job %}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="space-y-4">
                        <div class="flex items-center">
                            <svg class="w-5 h-5 text-gray-400 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div>
                                <p class="text-sm text-gray-400">Started</p>
                                <p class="text-white font-medium">{{ last_job.started_at|default:"Not started" }}</p>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <svg class="w-5 h-5 text-gray-400 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            <div>
                                <p class="text-sm text-gray-400">Completed</p>
                                <p class="text-white font-medium">{{ last_job.completed_at|default:"Not completed" }}</p>
                            </div>
                        </div>
                    </div>

                    {% if last_job.status == 'completed' %}
                    <div class="space-y-4">
                        <div class="flex items-center">
                            <svg class="w-5 h-5 text-gray-400 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                            </svg>
                            <div>
                                <p class="text-sm text-gray-400">Final Accuracy</p>
                                <p class="text-white font-medium">{{ last_job.model.accuracy|floatformat:2 }}%</p>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <svg class="w-5 h-5 text-gray-400 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div>
                                <p class="text-sm text-gray-400">Training Time</p>
                                <p class="text-white font-medium">
                                    {% if last_job.started_at and last_job.completed_at %}
                                        {{ last_job.completed_at|timeuntil:last_job.started_at }}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>

                {% if last_job.status == 'completed' %}
                <div class="bg-gray-900/50 rounded-lg p-4 border border-red-800/20">
                    <h3 class="text-lg font-medium text-white mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                        </svg>
                        Cost Variation During Training
                    </h3>
                    <div class="h-64">
                        <canvas id="costVariationChart"></canvas>
                    </div>
                </div>
                {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if last_job and last_job.status == 'completed' %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const trainingHistory = JSON.parse('{{ last_job.model.parameters.training_history|safe }}');
    const ctx = document.getElementById('costVariationChart').getContext('2d');
    
    // Calculate statistics
    const costs = trainingHistory.map(h => h.cost);
    const minCost = Math.min(...costs);
    const maxCost = Math.max(...costs);
    const avgCost = costs.reduce((a, b) => a + b, 0) / costs.length;
    
    // Create gradient
    const gradient = ctx.createLinearGradient(0, 0, 0, 200);
    gradient.addColorStop(0, 'rgba(239, 68, 68, 0.3)');
    gradient.addColorStop(1, 'rgba(239, 68, 68, 0)');
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: trainingHistory.map(h => h.iteration),
            datasets: [{
                label: 'Cost',
                data: trainingHistory.map(h => h.cost),
                borderColor: '#ef4444',
                backgroundColor: gradient,
                tension: 0.4,
                fill: true,
                pointRadius: 0,
                pointHoverRadius: 4,
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    borderColor: '#ef4444',
                    borderWidth: 1,
                    padding: 10,
                    displayColors: false,
                    callbacks: {
                        label: function(context) {
                            return `Cost: ${context.parsed.y.toFixed(4)}`;
                        },
                        title: function(context) {
                            return `Iteration ${context[0].label}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    title: {
                        display: true,
                        text: 'Cost',
                        color: '#fff',
                        font: {
                            weight: 'bold',
                            size: 12
                        }
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)',
                        drawBorder: false
                    },
                    ticks: {
                        color: '#fff',
                        callback: function(value) {
                            return value.toFixed(4);
                        }
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)',
                        drawBorder: false
                    },
                    ticks: {
                        color: '#fff'
                    }
                }
            }
        }
    });
});
</script>
{% endif %}
{% endblock %} 